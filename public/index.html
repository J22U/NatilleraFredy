<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natillera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .card-gradient-green { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .card-gradient-blue { background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); }
        .card-gradient-purple { background: linear-gradient(135deg, #6d28d9 0%, #8b5cf6 100%); }

        .swal2-popup { border-radius: 28px !important; padding: 1.5rem !important; width: 580px !important; }
        .swal-input-label { display: block; text-align: left; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 0.5rem 0.5rem; }
        .swal-custom-input { width: 100%; padding: 0.8rem 1.2rem; margin-bottom: 1.2rem; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 1rem; outline: none; transition: all 0.2s; }
        .swal-custom-input:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .historial-box { max-height: 150px; overflow-y: auto; border-radius: 16px; padding: 10px; border: 1px solid #f1f5f9; background: #fafafa; }
        .historial-box::-webkit-scrollbar { width: 4px; }
        .historial-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-slate-900 text-white shadow-2xl sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-500 p-2 rounded-xl shadow-lg"><i class="fas fa-vault text-xl text-white"></i></div>
            <h1 class="text-xl font-black tracking-tight uppercase">Natillera<span class="text-indigo-400 font-light italic ml-1"></span></h1>
        </div>
        
        <div class="flex items-center gap-6">
            <div id="current-date" class="hidden md:block text-[10px] font-medium text-slate-400 uppercase tracking-widest border-r border-slate-700 pr-6"></div>
            
            <button onclick="cerrarSesion()" class="flex items-center gap-2 hover:text-red-400 transition-colors group">
                <span class="text-[10px] font-black uppercase tracking-widest hidden sm:block">Salir</span>
                <i class="fas fa-power-off text-slate-500 group-hover:text-red-400 transition-colors"></i>
            </button>
        </div>
    </div>
</header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="card-gradient-green p-6 rounded-[2rem] text-white shadow-xl transform transition hover:scale-[1.02]">
                <div class="flex justify-between items-start">
                    <div><p class="text-green-100/80 text-xs font-bold uppercase tracking-widest">Total Ahorrado</p><h3 class="text-3xl font-black mt-2" id="dash-ahorro">$ 0</h3></div>
                    <div class="bg-white/20 p-3 rounded-2xl"><i class="fas fa-piggy-bank"></i></div>
                </div>
            </div>
            <div class="card-gradient-blue p-6 rounded-[2rem] text-white shadow-xl transform transition hover:scale-[1.02]">
                <div class="flex justify-between items-start">
                    <div><p class="text-blue-100/80 text-xs font-bold uppercase tracking-widest">Capital Prestado</p><h3 class="text-3xl font-black mt-2" id="dash-prestamos">$ 0</h3></div>
                    <div class="bg-white/20 p-3 rounded-2xl"><i class="fas fa-hand-holding-dollar"></i></div>
                </div>
            </div>
            <div class="card-gradient-purple p-6 rounded-[2rem] text-white shadow-xl transform transition hover:scale-[1.02]">
                <div class="flex justify-between items-start">
                    <div><p class="text-purple-100/80 text-xs font-bold uppercase tracking-widest">Ganancias Brutas</p><h3 class="text-3xl font-black mt-2" id="dash-ganancia">$ 0</h3></div>
                    <div class="bg-white/20 p-3 rounded-2xl"><i class="fas fa-chart-line"></i></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold mb-5 flex items-center gap-3"><span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span> Nuevo Miembro</h2>
                    <div class="space-y-3">
                        <input type="text" id="p_nombre" placeholder="Nombre completo" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-indigo-500 outline-none transition-all">
                        <input type="text" id="p_documento" placeholder="C√©dula / ID" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-indigo-500 outline-none transition-all">
                        <select id="p_esSocio" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-indigo-500 outline-none cursor-pointer">
                            <option value="1">Socio (Ahorrador)</option>
                            <option value="0">Externo (Solo Pr√©stamos)</option>
                        </select>
                        <button onclick="crearPersona()" class="w-full bg-slate-900 hover:bg-indigo-600 text-white font-bold py-4 rounded-2xl transition-all shadow-lg">Guardar Miembro</button>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold mb-5 flex items-center gap-3"><span class="w-1.5 h-6 bg-amber-500 rounded-full"></span> Abonos y Pagos</h2>
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                            <input type="number" id="mov_id" oninput="actualizarListaDeudas()" placeholder="ID Pantalla (#1, #2...)" class="w-full p-3 mb-2 rounded-xl bg-white border border-slate-200 outline-none">
                            <input type="number" id="mov_monto" placeholder="Monto $" class="w-full p-3 mb-3 rounded-xl bg-white border border-slate-200 outline-none">
                            
                            <select id="mov_tipo" onchange="toggleDeudas()" class="w-full p-3 mb-2 rounded-xl border border-slate-200 outline-none text-sm font-semibold">
                                <option value="ahorro">üí∞ Abono a Ahorro</option>
                                <option value="deuda">üìâ Abono a Deuda Espec√≠fica</option>
                            </select>

                            <div id="div_selector_deuda" class="hidden mb-4">
                                <label class="text-[10px] font-bold text-indigo-500 ml-2">SELECCIONAR PR√âSTAMO:</label>
                                <select id="mov_prestamo_id" class="w-full p-3 rounded-xl border-2 border-indigo-200 outline-none text-xs bg-white font-bold"></select>
                            </div>

                            <button onclick="registrarMovimiento()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold hover:bg-amber-600 transition-all shadow-md">Procesar Movimiento</button>
                        </div>
                        <button onclick="modalPrestamoRapido()" class="w-full py-4 border-2 border-dashed border-blue-200 rounded-2xl text-blue-600 font-bold hover:bg-blue-50 transition-all flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Nuevo Pr√©stamo</button>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-8">
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex flex-col">
                            <h2 class="text-xl font-bold">Listado de Miembros</h2>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[9px] font-black uppercase bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full" id="count-ahorradores">0 Ahorradores</span>
                                <span class="text-[9px] font-black uppercase bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full" id="count-prestamos">0 Externos</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <div class="relative w-full">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="inputBusqueda" onkeyup="filtrarSocios()" placeholder="Buscar socio..." class="pl-11 pr-4 py-3 bg-slate-100 border-none rounded-2xl text-sm w-full outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button onclick="cargarTodo()" class="bg-indigo-50 text-indigo-600 p-3 rounded-xl hover:bg-indigo-100 transition-colors"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-widest">
                                <tr>
                                    <th class="px-8 py-4">#</th>
                                    <th class="px-8 py-4">Informaci√≥n del Miembro</th>
                                    <th class="px-8 py-4 text-center">Gesti√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-recientes" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>

        // Al inicio de tu script en index.html
if (localStorage.getItem('isLogged') !== 'true') {
    window.location.href = '/login.html';
}

// Bot√≥n de cerrar sesi√≥n (opcional)
function cerrarSesion() {
    localStorage.removeItem('isLogged');
    window.location.href = '/login.html';
}
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
        window.mapeoIdentificadores = {};

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            cargarTodo();
        });

        function cargarTodo() { cargarDashboard(); listarMiembros(); }

        async function cargarDashboard() {
            try {
                const res = await fetch('/reporte-general');
                const data = await res.json();
                document.getElementById('dash-ahorro').innerText = `$ ${Number(data.TotalAhorrado || 0).toLocaleString()}`;
                document.getElementById('dash-prestamos').innerText = `$ ${Number(data.CapitalPrestado || 0).toLocaleString()}`;
                document.getElementById('dash-ganancia').innerText = `$ ${Number(data.GananciasBrutas || 0).toLocaleString()}`;
            } catch (err) { console.error(err); }
        }

        async function listarMiembros() {
    try {
        const res = await fetch('/listar-miembros');
        const miembros = await res.json();
        const tbody = document.getElementById('tabla-recientes');
        tbody.innerHTML = '';
        window.mapeoIdentificadores = {}; 

        let cAhorro = 0, cExtra = 0;
        
        // 1. Calculamos el total de miembros recibidos
        const totalMiembros = miembros.length;

        // 2. Usamos .reverse() para que el √∫ltimo de la DB salga primero en la lista
        miembros.reverse().forEach((m, index) => {
            
            // 3. L√ìGICA DE NUMERACI√ìN:
            // Si hay 10 miembros, el primero de la lista (el m√°s nuevo) ser√°: 10 - 0 = #10
            // El segundo ser√°: 10 - 1 = #9 ... y as√≠ sucesivamente.
            const numPantalla = totalMiembros - index;

            window.mapeoIdentificadores[numPantalla] = m.id; 
            const esSocioReal = (m.tipo === 'SOCIO'); 
            esSocioReal ? cAhorro++ : cExtra++;

            tbody.innerHTML += `
                <tr class="hover:bg-slate-50 transition-colors item-socio">
                    <td class="px-8 py-5 font-black text-indigo-500 text-xl">#${numPantalla}</td>
                    <td class="px-8 py-5">
                        <div class="font-semibold text-slate-700 nombre-socio text-lg">${m.nombre}</div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-tighter">
                            DOC: ${m.cedula} | 
                            <span class="${esSocioReal ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'} px-2 py-0.5 rounded-full font-black text-[9px] ml-2">
                                ${m.tipo}
                            </span>
                        </div>
                    </td>
                    <td class="px-8 py-5 text-center">
                        <div class="flex justify-center gap-3">
                            <button onclick="verHistorialFechas(${m.id}, '${m.nombre}')" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all">Resumen</button>
                            <button onclick="editarSocio(${m.id}, '${m.nombre}', '${m.cedula}')" class="text-amber-500 p-2"><i class="fas fa-pen"></i></button>
                            <button onclick="eliminarSocio(${m.id})" class="text-rose-400 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
        });
        document.getElementById('count-ahorradores').innerText = `${cAhorro} Ahorradores`;
        document.getElementById('count-prestamos').innerText = `${cExtra} Externos`;
    } catch (err) { console.error(err); }
}

        async function actualizarListaDeudas() {
    const numPantalla = document.getElementById('mov_id').value;
    const idReal = window.mapeoIdentificadores[numPantalla];
    const select = document.getElementById('mov_prestamo_id');
    const inputMonto = document.getElementById('mov_monto'); 
    
    if (!idReal) {
        select.innerHTML = '<option value="">Ingrese ID de socio</option>';
        return;
    }

    try {
        // Consultamos el detalle completo que ya trae SaldoActual e intereses
        const res = await fetch(`/detalle-prestamo/${idReal}`);
        const prestamos = await res.json();
        
        // Filtramos solo los que tengan deuda seg√∫n el SaldoActual de la DB
        const activos = prestamos.filter(p => Number(p.SaldoActual) > 0);
        
        if (activos.length > 0) {
            select.innerHTML = activos.map((p, index) => {
                // AQU√ç EST√Å EL ARREGLO: 
                // No restamos nada a mano, usamos el saldo que manda SQL
                const saldoReal = Number(p.SaldoActual); 
                const numPrestamoSocio = index + 1; 

                return `<option value="${p.ID_Prestamo}" data-saldo="${saldoReal}">
                    Pr√©stamo #${numPrestamoSocio} (Saldo: $${saldoReal.toLocaleString()})
                </option>`;
            }).join('');
            
            select.onchange = () => {
                const saldo = select.options[select.selectedIndex].getAttribute('data-saldo');
                inputMonto.placeholder = `M√°ximo: $${Number(saldo).toLocaleString()}`;
            };
            select.onchange();
            
        } else {
            select.innerHTML = '<option value="">Sin deudas activas</option>';
            inputMonto.placeholder = "Monto $";
        }
    } catch (e) { console.error("Error al actualizar deudas:", e); }
}

        async function verHistorialFechas(id, nombre) {
    // 1. Mostrar carga inicial
    Swal.fire({
        title: 'Cargando datos...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        // 2. Peticiones al servidor
        const [resA, resP, resAb, resTotales] = await Promise.all([
            fetch(`/historial-ahorros/${id}`),
            fetch(`/detalle-prestamo/${id}`),
            fetch(`/historial-abonos-deuda/${id}`),
            fetch(`/estado-cuenta/${id}`)
        ]);

        const a = await resA.json();
        const p = await resP.json();
        const ab = await resAb.json();
        const totales = await resTotales.json();

        // 3. Definir los Renders (deben estar DENTRO para usar las variables)
        const renderSimple = (data, key, color) => {
            if (!data || data.length === 0) return '<p class="text-center py-2 text-slate-300 text-[10px] italic">Sin movimientos</p>';
            return data.map(m => `
                <div class="flex justify-between p-2 border-b border-white/50 text-[11px]">
                    <span class="text-slate-500 font-medium">${m.FechaFormateada || m.FechaPrestamo || 'S/F'}</span>
                    <span class="font-bold text-${color}-600">$${Number(m[key] || 0).toLocaleString()}</span>
                </div>
            `).join('');
        };

        const renderPrestamos = (data) => {
    if (!data || data.length === 0) return '<p class="text-center py-2 text-slate-300 text-[10px] italic">Sin pr√©stamos</p>';
    
    return data.map((m, index) => {
        const saldo = Number(m.SaldoActual || 0);
        const interes = Number(m.MontoInteres || 0);
        const capital = Number(m.MontoPrestado || 0);
        const tasa = m.TasaInteres || 5; // Por defecto 5% si no existe
        const cuotas = m.Cuotas || 1;
        
        // El monto total es Capital + Inter√©s
        const montoTotal = capital + interes;
        const estaPago = saldo <= 0 || m.Estado === 'Pagado';
        
        return `
        <div class="p-2 mb-2 rounded-xl border ${estaPago ? 'bg-emerald-100 border-emerald-200' : 'bg-blue-50 border-blue-100'}">
            <div class="flex justify-between items-center text-[11px]">
                <span class="font-black text-indigo-600">PR√âSTAMO #${index + 1}</span>
                <span class="${estaPago ? 'text-emerald-700' : 'text-slate-500'} font-bold">
                    ${estaPago ? '‚úÖ PAGADO' : 'üìÖ ' + (m.FechaPrestamo || 'S/F')}
                </span>
            </div>

            <div class="flex gap-2 my-1">
                <span class="bg-white/60 px-2 py-0.5 rounded text-[9px] font-bold text-slate-500 border border-slate-200">
                    <i class="fas fa-percentage mr-1"></i>Tasa: ${tasa}%
                </span>
                <span class="bg-white/60 px-2 py-0.5 rounded text-[9px] font-bold text-slate-500 border border-slate-200">
                    <i class="fas fa-calendar-alt mr-1"></i>Plazo: ${cuotas} cuota(s)
                </span>
            </div>

            <div class="flex justify-between items-end mt-2">
                 <div class="flex flex-col">
                    <span class="text-[8px] uppercase font-black text-slate-400">Total a devolver</span>
                    <span class="text-[12px] font-black text-slate-700">$${montoTotal.toLocaleString()}</span>
                    <span class="text-[8px] text-slate-400">(Cap: $${capital.toLocaleString()} + Int: $${interes.toLocaleString()})</span>
                 </div>
                ${!estaPago ? `
                    <div class="text-right">
                        <span class="text-[8px] text-rose-500 font-black uppercase">Saldo Pendiente</span>
                        <div class="text-[14px] text-rose-600 font-black leading-none">$${saldo.toLocaleString()}</div>
                    </div>` : ''}
            </div>
        </div>`;
    }).join('');
};

        const renderAbonosDetallados = (data) => {
    if (!data || data.length === 0) return '<p class="text-center py-2 text-slate-300 text-[10px] italic">Sin abonos</p>';
    return data.map(m => `
        <div class="p-2 border-b border-white/50 text-[11px]">
            <div class="flex justify-between">
                <span class="text-slate-500 font-medium">${m.FechaFormateada}</span>
                <span class="font-bold text-rose-600">+$${Number(m.Monto_Abonado).toLocaleString()}</span>
            </div>
            <div class="text-[9px] text-slate-400 italic">
                Aplicado a pr√©stamo de: $${Number(m.PrestamoRef || 0).toLocaleString()}
            </div>
        </div>
    `).join('');
};

        // 4. Mostrar el Modal Final (Cerramos el loading autom√°ticamente al abrir este)
        Swal.fire({
            title: `<span class="text-xl font-black">${nombre}</span>`,
            html: `
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-emerald-50 p-2 rounded-xl text-center border border-emerald-100">
                        <p class="text-[8px] uppercase font-bold text-emerald-600">Total Ahorrado</p>
                        <p class="font-black text-emerald-700 text-sm">$${Number(totales.totalAhorrado || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-rose-50 p-2 rounded-xl text-center border border-rose-100">
                        <p class="text-[8px] uppercase font-bold text-rose-600">Deuda Total</p>
                        <p class="font-black text-rose-700 text-sm">$${Number(totales.deudaTotal || 0).toLocaleString()}</p>
                    </div>
                </div>
                <div class="text-left space-y-4 max-h-[50vh] overflow-y-auto pr-1">
                    <div>
                        <h5 class="text-[9px] font-black uppercase text-emerald-500 mb-1 ml-1">üí∞ Historial de Ahorros</h5>
                        <div class="rounded-xl bg-emerald-50/50 p-1">${renderSimple(a, 'Monto', 'emerald')}</div>
                    </div>
                    <div>
                        <h5 class="text-[9px] font-black uppercase text-blue-500 mb-1 ml-1">üöÄ Pr√©stamos Detallados</h5>
                        <div class="rounded-xl bg-slate-50 p-1">${renderPrestamos(p)}</div>
                    </div>
                    <div>
                        <h5 class="text-[9px] font-black uppercase text-rose-500 mb-1 ml-1">üìâ Abonos realizados</h5>
                        <div class="rounded-xl bg-rose-50/50 p-1">${renderAbonosDetallados(ab)}</div>
                    </div>
                </div>`,
            showDenyButton: true,
            confirmButtonText: 'Cerrar',
            denyButtonText: 'üì• Descargar PDF',
            denyButtonColor: '#059669',
            confirmButtonColor: '#64748b'
        }).then((result) => {
            if (result.isDenied) {
                generarPDFMovimientos(nombre, a, p, ab, totales);
            }
        });

    } catch (e) {
        console.error("Error en el historial:", e);
        Swal.fire('Error', 'No se pudo cargar la informaci√≥n. Verifica la consola.', 'error');
    }
}

        // 4. Render para Abonos (Con el detalle de a qu√© pr√©stamo fue)
        const renderAbonosDetallados = (data) => {
            if (!data || data.length === 0) return '<p class="text-center py-2 text-slate-300 text-[10px] italic">Sin abonos</p>';
            return data.map(m => `
                <div class="p-2 border-b border-white/50 text-[11px]">
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">${m.FechaFormateada}</span>
                        <span class="font-bold text-rose-600">+$${Number(m.Monto_Abonado).toLocaleString()}</span>
                    </div>
                    <div class="text-[9px] text-slate-400 italic">
                        Aplicado a pr√©stamo de: $${Number(m.PrestamoOriginal || 0).toLocaleString()}
                    </div>
                </div>
            `).join('');
        };

        // 5. Mostrar el Modal
        Swal.fire({
            title: `<span class="text-xl font-black">${nombre}</span>`,
            html: `
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-emerald-50 p-2 rounded-xl text-center border border-emerald-100">
                        <p class="text-[8px] uppercase font-bold text-emerald-600 leading-tight">Total Ahorrado</p>
                        <p class="font-black text-emerald-700 text-sm">$${Number(totales.totalAhorrado).toLocaleString()}</p>
                    </div>
                    <div class="bg-rose-50 p-2 rounded-xl text-center border border-rose-100">
                        <p class="text-[8px] uppercase font-bold text-rose-600 leading-tight">Deuda Total</p>
                        <p class="font-black text-rose-700 text-sm">$${Number(totales.deudaTotal).toLocaleString()}</p>
                    </div>
                </div>
                <div class="text-left space-y-4 max-h-[50vh] overflow-y-auto pr-1">
                    <div>
                        <h5 class="text-[9px] font-black uppercase text-emerald-500 mb-1 ml-1">üí∞ Historial de Ahorros</h5>
                        <div class="rounded-xl bg-emerald-50/50 p-1">${renderSimple(a, 'Monto', 'emerald')}</div>
                    </div>
                    <div>
                        <h5 class="text-[9px] font-black uppercase text-blue-500 mb-1 ml-1">üöÄ Pr√©stamos Detallados</h5>
                        <div class="rounded-xl bg-slate-50 p-1">${renderPrestamos(p)}</div>
                    </div>
                    <div>
                        <h5 class="text-[9px] font-black uppercase text-rose-500 mb-1 ml-1">üìâ Abonos realizados</h5>
                        <div class="rounded-xl bg-rose-50/50 p-1">${renderAbonosDetallados(ab)}</div>
                    </div>
                </div>`,
            showDenyButton: true,
            confirmButtonText: 'Cerrar',
            denyButtonText: 'üì• Descargar PDF',
            denyButtonColor: '#059669',
            confirmButtonColor: '#64748b'
        }).then((result) => {
            if (result.isDenied) {
                generarPDFMovimientos(nombre, a, p, ab, totales);
            }
        });

        async function registrarMovimiento() {
    const numPantalla = document.getElementById('mov_id').value;
    const montoInput = document.getElementById('mov_monto');
    const monto = parseFloat(montoInput.value);
    const tipo = document.getElementById('mov_tipo').value;
    const selectDeuda = document.getElementById('mov_prestamo_id');
    const idReal = window.mapeoIdentificadores[numPantalla];

    if (!idReal || isNaN(monto)) return Toast.fire({ icon: 'warning', title: 'Faltan datos' });

    if (tipo === 'deuda') {
        if (!selectDeuda.value) return Toast.fire({ icon: 'error', title: 'Selecciona una deuda' });
        
        // VALIDACI√ìN: No permitir m√°s del saldo actual
        const saldoMaximo = parseFloat(selectDeuda.options[selectDeuda.selectedIndex].getAttribute('data-saldo'));
        if (monto > saldoMaximo) {
            return Swal.fire({
                icon: 'error',
                title: 'Monto excedido',
                text: `No puedes abonar $${monto.toLocaleString()} porque la deuda actual es de $${saldoMaximo.toLocaleString()}.`
            });
        }
    }

    apiCall('/procesar-movimiento', { 
        idPersona: idReal, 
        monto: monto, 
        tipoMovimiento: tipo,
        idPrestamo: tipo === 'deuda' ? selectDeuda.value : null
    }, "Movimiento procesado correctamente");

    // Limpiar campos
    document.getElementById('mov_id').value = ''; 
    montoInput.value = '';
    montoInput.placeholder = "Monto $";
}

        async function crearPersona() {
    // 1. Validamos que los elementos existan antes de leer su .value
    const inputNombre = document.getElementById('p_Nombre') || document.getElementById('p_nombre');
    const inputDocumento = document.getElementById('p_documento');
    const inputSocio = document.getElementById('p_esSocio');

    if (!inputNombre || !inputDocumento) {
        console.error("Error: No se encontraron los inputs en el HTML.");
        return;
    }

    const n = inputNombre.value.trim();
    const d = inputDocumento.value.trim();
    const s = inputSocio ? inputSocio.value : "0";

    if (!n || !d) return Toast.fire({ icon: 'warning', title: 'Faltan datos' });

    try {
        // Usamos variables claras para evitar el "nombre is not defined"
        await apiCall('/guardar-miembro', { 
            nombre: n, 
            cedula: d, 
            esSocio: s === "1" ? 1 : 0 
        }, "Miembro guardado");

        // Limpieza segura
        inputNombre.value = '';
        inputDocumento.value = '';
    } catch (e) {
        console.error("Error en la llamada:", e);
    }
}
        async function apiCall(ruta, datos, msg) {
            try {
                const res = await fetch(ruta, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(datos) });
                const r = await res.json();
                if(r.success) { Toast.fire({ icon: 'success', title: msg }); cargarTodo(); } else throw new Error(r.message);
            } catch (e) { Swal.fire({ icon: 'error', title: 'Error', text: e.message }); }
        }

        function filtrarSocios() {
            let input = document.getElementById("inputBusqueda").value.toLowerCase();
            let filas = document.getElementsByClassName("item-socio");
            Array.from(filas).forEach(fila => {
                let nombre = fila.querySelector(".nombre-socio").innerText.toLowerCase();
                fila.style.display = nombre.includes(input) ? "" : "none";
            });
        }

        async function modalPrestamoRapido() {
    const { value: formValues } = await Swal.fire({
        title: 'Nuevo Pr√©stamo',
        html: `
            <div class="text-left space-y-3">
                <div>
                    <label class="swal-input-label"># Socio en pantalla</label>
                    <input id="p-id" type="number" class="swal-custom-input" placeholder="Ej: 1, 2...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="swal-input-label">Monto Capital ($)</label>
                        <input id="p-m" type="number" class="swal-custom-input" placeholder="0">
                    </div>
                    <div>
                        <label class="swal-input-label">Inter√©s Mensual (%)</label>
                        <input id="p-tasa" type="number" class="swal-custom-input" value="5">
                    </div>
                </div>
                <div>
                    <label class="swal-input-label">N√∫mero de Cuotas</label>
                    <select id="p-cuotas" class="swal-custom-input cursor-pointer">
                        <option value="1">1 Mes (Pago √∫nico)</option>
                        <option value="2">2 Meses</option>
                        <option value="3">3 Meses</option>
                        <option value="6">6 Meses</option>
                        <option value="12">12 Meses</option>
                    </select>
                </div>
                <div class="bg-slate-900 p-4 rounded-2xl text-white shadow-inner">
                    <div class="flex justify-between text-[10px] text-slate-400 font-bold uppercase mb-2">
                        <span>Resumen del Cr√©dito</span>
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="space-y-1 border-b border-white/10 pb-2 mb-2">
                        <div class="flex justify-between text-xs"><span>Inter√©s total:</span> <span id="calc-interes" class="text-rose-400 font-bold">$ 0</span></div>
                        <div class="flex justify-between text-xs"><span>Total a pagar:</span> <span id="calc-total" class="text-emerald-400 font-bold">$ 0</span></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold uppercase text-indigo-300">Valor de cada cuota:</span>
                        <span id="calc-cuota" class="text-lg font-black text-white">$ 0</span>
                    </div>
                </div>
            </div>`,
        didOpen: () => {
            const inputs = ['p-m', 'p-tasa', 'p-cuotas'];
            const calcular = () => {
                const capital = parseFloat(document.getElementById('p-m').value) || 0;
                const tasa = parseFloat(document.getElementById('p-tasa').value) || 0;
                const nCuotas = parseInt(document.getElementById('p-cuotas').value);

                // L√≥gica Natillera: El inter√©s se aplica sobre el capital inicial por el tiempo pactado
                const interesTotal = capital * (tasa / 100) * nCuotas;
                const totalADevolver = capital + interesTotal;
                const valorCuota = totalADevolver / nCuotas;

                document.getElementById('calc-interes').innerText = `$ ${interesTotal.toLocaleString()}`;
                document.getElementById('calc-total').innerText = `$ ${totalADevolver.toLocaleString()}`;
                document.getElementById('calc-cuota').innerText = `$ ${valorCuota.toLocaleString()}`;
            };
            inputs.forEach(id => document.getElementById(id).addEventListener('input', calcular));
            inputs.forEach(id => document.getElementById(id).addEventListener('change', calcular));
        },
        preConfirm: () => {
            const idReal = window.mapeoIdentificadores[document.getElementById('p-id').value];
            const monto = parseFloat(document.getElementById('p-m').value);
            const tasa = parseFloat(document.getElementById('p-tasa').value);
            const cuotas = parseInt(document.getElementById('p-cuotas').value);

            if (!idReal) return Swal.showValidationMessage(`Socio no encontrado`);
            if (!monto || monto <= 0) return Swal.showValidationMessage(`Monto inv√°lido`);
            
            return { idPersona: idReal, monto, tasaInteres: tasa, cuotas };
        }
    });

    if (formValues) apiCall('/registrar-prestamo', formValues, "Pr√©stamo registrado");
}

       function eliminarSocio(id) {
    Swal.fire({ 
        title: '¬øEliminar socio?', 
        text: "Esta acci√≥n no se puede deshacer.", 
        icon: 'warning', 
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((r) => { 
        if (r.isConfirmed) {
            // Enviamos un objeto donde la propiedad se llame "id"
            // Debe coincidir con la ruta del servidor '/eliminar-socio'
            apiCall('/eliminar-socio', { id: id }, "Socio eliminado"); 
        } 
    });
}

        async function editarSocio(id, n, c) {
    const { value: f } = await Swal.fire({
        title: 'Editar Miembro',
        html: `
            <label class="swal-input-label">Nombre</label>
            <input id="en" class="swal-custom-input" value="${n}">
            <label class="swal-input-label">C√©dula</label>
            <input id="ec" class="swal-custom-input" value="${c}">
        `,
        preConfirm: () => ({ 
            nombre: document.getElementById('en').value, 
            cedula: document.getElementById('ec').value 
        })
    });

    // CORRECCI√ìN: Se agrega /${id} a la URL para que coincida con el servidor
    if (f) apiCall(`/editar-socio/${id}`, f, "Actualizado");
}

        function generarPDFMovimientos(nombre, ahorros, prestamos, abonos, totales) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const fechaDoc = new Date().toLocaleDateString();

    // 1. ENCABEZADO ELEGANTE
    doc.setFillColor(99, 102, 241); // Color Indigo
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFontSize(22);
    doc.setTextColor(255, 255, 255);
    doc.text("EXTRACTO DE CUENTA", 14, 20);
    doc.setFontSize(10);
    doc.text("SISTEMA DE GESTI√ìN NATILLERA PRO", 14, 28);

    doc.setFontSize(12);
    doc.setTextColor(255, 255, 255);
    doc.text(`CLIENTE: ${nombre.toUpperCase()}`, 120, 20);
    doc.text(`FECHA: ${fechaDoc}`, 120, 28);

    // 2. RESUMEN DE TOTALES (Caja de impacto)
    doc.autoTable({
        startY: 45,
        head: [['RESUMEN GENERAL', 'VALOR TOTAL']],
        body: [
            ['TOTAL AHORRADO A LA FECHA', `$ ${Number(totales.totalAhorrado || 0).toLocaleString()}`],
            ['DEUDA PENDIENTE (Capital + Intereses)', `$ ${Number(totales.deudaTotal || 0).toLocaleString()}`]
        ],
        theme: 'striped',
        headStyles: { fillStyle: [31, 41, 55], fontStyle: 'bold' },
        styles: { fontSize: 10, cellPadding: 3 }
    });

    // 3. TABLA DE AHORROS (Verde)
    doc.setFontSize(12);
    doc.setTextColor(16, 185, 129);
    doc.text("1. DETALLE DE AHORROS", 14, doc.lastAutoTable.finalY + 12);
    
    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 15,
        head: [['#', 'Fecha de Aporte', 'Monto Ahorrado']],
        body: ahorros.map((item, index) => [
            index + 1,
            item.FechaFormateada || 'S/F',
            `$ ${Number(item.Monto).toLocaleString()}`
        ]),
        headStyles: { fillStyle: [16, 185, 129] },
        styles: { fontSize: 9 }
    });

    // 4. TABLA DE PR√âSTAMOS (Azul) - Incluye Tasa y Cuotas
    doc.setFontSize(12);
    doc.setTextColor(59, 130, 246);
    doc.text("2. DETALLE DE PR√âSTAMOS", 14, doc.lastAutoTable.finalY + 12);

    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 15,
        head: [['ID', 'Fecha', 'Tasa', 'Cuotas', 'Monto Total', 'Saldo Pendiente', 'Estado']],
        body: prestamos.map((item, index) => {
            const capital = Number(item.MontoPrestado || 0);
            const interes = Number(item.MontoInteres || 0);
            const totalConInteres = capital + interes;
            const saldo = Number(item.SaldoActual || 0);

            return [
                `#${index + 1}`,
                item.FechaPrestamo || 'S/F',
                `${item.TasaInteres || 5}%`,
                item.Cuotas || 1,
                `$ ${totalConInteres.toLocaleString()}`,
                `$ ${saldo.toLocaleString()}`,
                item.Estado.toUpperCase()
            ];
        }),
        headStyles: { fillStyle: [59, 130, 246] },
        styles: { fontSize: 8 }
    });

    // 5. TABLA DE ABONOS (Rojo/Rosa) - Con referencia corregida
    doc.setFontSize(12);
    doc.setTextColor(244, 63, 94);
    doc.text("3. HISTORIAL DE PAGOS A DEUDA", 14, doc.lastAutoTable.finalY + 12);

    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 15,
        head: [['Fecha de Pago', 'Valor del Abono', 'Referencia del Pr√©stamo']],
        body: abonos.map(i => {
            // Usamos PrestamoRef o PrestamoOriginal dependiendo de lo que env√≠e tu servidor
            const ref = i.PrestamoRef || i.PrestamoOriginal || 0;
            return [
                i.FechaFormateada, 
                `$ ${Number(i.Monto_Abonado).toLocaleString()}`,
                `Aplicado a pr√©stamo de $${Number(ref).toLocaleString()}`
            ];
        }),
        headStyles: { fillStyle: [244, 63, 94] }, 
        styles: { fontSize: 9 }
    });

    // PIE DE P√ÅGINA
    const finalY = doc.lastAutoTable.finalY + 20;
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text("Este documento es un extracto informativo generado por Natillera Pro.", 14, finalY);
    doc.text("Verifique sus movimientos peri√≥dicamente.", 14, finalY + 4);

    // Guardar el archivo
    doc.save(`Extracto_${nombre.replace(/\s+/g, '_')}_${fechaDoc.replace(/\//g, '-')}.pdf`);
}

async function cargarPrestamosEnSelector(idPersona) {
    const selector = document.getElementById('tu_id_del_selector_de_prestamos'); // Ajusta el ID
    selector.innerHTML = '<option value="">Cargando pr√©stamos...</option>';

    try {
        const res = await fetch(`/prestamos-activos/${idPersona}`);
        const prestamos = await res.json();

        selector.innerHTML = '<option value="">Seleccione un pr√©stamo</option>';
        
        if (prestamos.length === 0) {
            selector.innerHTML = '<option value="">Sin pr√©stamos activos</option>';
            return;
        }

        prestamos.forEach(p => {
            const option = document.createElement('option');
            option.value = p.ID_Prestamo;
            // Esto har√° que se vea como en tu foto: "Pr√©stamo #21 (Saldo: $200.000)"
            option.textContent = `Pr√©stamo #${p.ID_Prestamo} (Saldo: $${p.SaldoActual.toLocaleString()})`;
            selector.appendChild(option);
        });
    } catch (error) {
        console.error("Error al cargar pr√©stamos:", error);
    }
}
    </script>
</body>
</html>